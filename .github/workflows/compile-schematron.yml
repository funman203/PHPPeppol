name: Compile Schematron

on:
  workflow_dispatch:  # Manuel
  schedule:
    - cron: '0 0 1 * *'  # 1er de chaque mois (vÃ©rifier updates)

jobs:
  compile:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, xml, xsl, zip
      
      - name: Install dependencies
        run: composer install --no-dev --prefer-dist
      
      - name: Install ISO Schematron XSLT (for compilation)
        run: |
          php -r "
          require 'vendor/autoload.php';
          \$v = new Peppol\Validation\SchematronValidator();
          \$results = \$v->installIsoSchematronXslt();
          foreach (\$results as \$file => \$success) {
              echo (\$success ? 'âœ…' : 'âŒ') . \" \$file\n\";
          }
          "
      
      - name: Compile Schematron files
        run: php bin/compile-schematron.php --all --force
      
      - name: Verify compilation
        run: php bin/verify-compiled.php
      
      - name: Check for changes
        id: changes
        run: |
          git diff --quiet resources/compiled/ || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: Update compiled Schematron files'
          title: 'ðŸ¤– Update Schematron compiled files'
          body: |
            ## Automatic Schematron Update
            
            This PR updates the compiled Schematron XSLT files.
            
            ### Changes
            - Downloaded latest source files from official sources
            - Compiled Schematron rules to XSLT
            - Updated metadata.json with checksums and timestamps
            
            ### Sources
            - **UBL.BE**: https://www.ubl.be/
            - **EN 16931**: https://github.com/ConnectingEurope/eInvoicing-EN16931
            - **Peppol BIS**: https://github.com/OpenPEPPOL/peppol-bis-invoice-3
            
            ### Testing
            Please verify that:
            - [ ] All compiled files are present in `resources/compiled/`
            - [ ] `metadata.json` is up to date
            - [ ] Tests pass: `composer test`
            - [ ] Validation works: `php bin/validate-invoice tests/fixtures/valid-ublbe-invoice.xml --schematron`
            
            Auto-generated by GitHub Actions on ${{ github.run_id }}
          branch: update-schematron-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            schematron
            dependencies
